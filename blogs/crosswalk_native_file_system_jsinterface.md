# crosswalk 本地文件系统javascript api

`android` `crosswalk/xwalk` `file_system` `javascript`

## 精简版 

talk is cheap ,show me the [code](https://github.com/nbwsc/blog/blob/master/blogs/xwalk_file.js)

## 故事版

由于一些历史原因,要使所有用户进行应用升级，但是没有内置升级系统，整个过程非常复杂，不写下来对不起自己。。

### 需求：
1. 升级app（android application ，使用嵌入式crosswalk，加上webonline。）
2. 用户尽量少操作
3. 保留用户原有信息（crosswalk的localStorage中）

### 分析

其实还有几条路可以走本来，比如重定向，也能解决当前问题，但是后来发现应用逻辑限制，本身不支持重定向。
那么只能升级app，升级app有几个步骤，一个是下载，一个是打开apk（最好能静默安装，但是应用没有root或系统应用权限）。现在能改动的只有crosswalk中执行的javascript。

有几种办法可以使用js借助浏览器下载：

1. 带download属性的a标签
2. iframe下载
3. http请求带上返回附件头

三种都可以下载，但是在实际环境测试中，用户使用的安卓盒子有一种阉割比较厉害的rom，我们先管它叫xlrom，从`adb logcat`中看到浏览器一下载系统就会杀掉这个进程，所以js下载在这种盒子上不行，这就意味着无法下载apk。

所以这个路走不通了。后来决定发通知，让用户从应用市场下载，虽然会有一些操作性，但是可能是唯一的办法了。

那就暂时不考虑升级app的问题了。同时，既然要升级应用，那么浏览器和域名都改了，如何共享当前域名下的用户信息呢。由两种方案
1. 写入本地共享文件
2. 将用户信息和设备信息（不是浏览器信息）关联

方案1的话正常情况下是可以的，就是使用下载的方式，下载一个js生成内容的文件。可以这么弄：

```
TODO : ADD CODE HERE

```
但是上面提到了某种盒子下是不能下载的。所以这个方案也不行。而原应用并没有提供任何原生读写的能力（我原以为没有，其实crosswalk封装了），似乎也走不通了。

方案2的话，我翻阅了很多信息，没有找到js能够拿到uuid或者设备指纹之类的，`client.js`封装的浏览器指纹在crosswalk中也拿不到，而且浏览器指纹也没有用。
我甚至尝试从网络请求中获取信息，客户端的ip是能拿到，但是ip不稳定，经常变，所以不能作为客户端的票据，而且我们的用户有一个路由器下数个设备的情况。客户端的mac地址我也尝试拿过，但是不行，因为mac地址在http请求中只能维持一跳，一旦跳出路由器mac地址就变了，服务器只能拿到最后一跳的mac地址，所以也失败了。我甚至看了裸tcp能不能做这个事情，结果也都失败了。

在最后几乎绝望的情况下，我想这个crosswalk有没有预留什么特殊的接口呢，于是正文开始了；

我直接开着adb crosswalk的调试，在console里`console.dir(window`查看里面所有变量，发现有一个xwalk的全局变量.里面有一个